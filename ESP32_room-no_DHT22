// Library initialisation (actual try: ivosys.de/blog)
#include "DHT.h"           //Sensors
#include "WiFi.h"          // WiFi
#include "PubSubClient.h"  //MQTT

// DHT sensor info und Aufruf
#define DHTPIN 21
#define DHTTYPE DHT22
DHT dht(DHTPIN, DHTTYPE);

// WiFi & MQTT connection
const char* mqttServer = "192.168.2.132";
uint16_t mqttPort = safety;
const char* mqtt_user = "safety";
const char* mqtt_pass = "safety";
const char* clientID = "ESP32_Werkstatt-01_DHT22";
WiFiClient espClient;  //Client erstellen
PubSubClient client(espClient);

const char* topic_t = "Link/UG/Werkstatt/Klima/Temperatur";          //publiziertes Thema1 t
const char* topic_rHum = "Link/UG/Werkstatt/Klima/Luftfeuchte";          //publiziertes Thema2 rHum
const char* topic_ib = "Link/UG/Werkstatt/Klima/inbound";  // abonniertes Thema inbound

//Timer anstelle delay
unsigned long timer = 0;
const long verzoegerung = 300000; 

void setup() {
  // put your setup code here, to run once:
  Serial.begin(9600);
  dht.begin();  // initialize the DHT22 sensor

  WiFi.begin("safety", "safety");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.println("WLAN Verbindungsversuch...");
    delay(500);
  }

  // MQTT-Client mit Broker verbinden
  client.setServer(mqttServer, mqttPort);
  while (!client.connected()) {
    client.connect(clientID, mqtt_user, mqtt_pass);
    Serial.println("ESP32_Werkstatt-01_DHT22: Verbindung zum Broker wird hergestellt.");
    delay(1000);
  }
  if (client.connect("ESP32_Werkstatt-01_DHT22", mqtt_user, mqtt_pass)) {
    Serial.println("ESP32_Werkstatt-01_DHT22: Verbindung zum Broker erfolgreich hergestellt.");
  } else {
    Serial.println("ESP32_Werkstatt-01_DHT22: Broker-Verbindung fehlgeschlagen.");
  }
  // Topics abonnieren
  client.subscribe(topic_ib);
}




void loop() {
  client.loop();
  unsigned long timer_aktuell = millis();
  if (timer_aktuell - timer >= verzoegerung) {
    timer = timer_aktuell;
    // read humidity
    float relHum = dht.readHumidity();
    // read temperature in Celsius
    float temp = dht.readTemperature();

    // check whether the reading is successful or not
    if (isnan(temp) || isnan(relHum)) {
      Serial.println("Failed DHT22 reading.");
    } else {
      Serial.print("rel. Humidity:");
      Serial.print(relHum);
      Serial.print("%");
      Serial.print("  |  ");
      Serial.print("Temperature:");
      Serial.print(temp);
      Serial.println("°C");
      // Daten über MQTT veröffentlichen
      client.publish(topic_t, String(temp).c_str());
      client.publish(topic_rHum, String(relHum).c_str());
    }
  }
}
